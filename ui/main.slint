import { Button, LineEdit, ScrollView, TextEdit, CheckBox, HorizontalBox, VerticalBox, TabWidget } from "std-widgets.slint";

export struct JobEntry {
    id: string,
    title: string,
    employer: string,
    location: string,
    description: string,
    date: string,
    rating: int,
    status_text: string,
}

export struct AppSettings {
    keywords: string,
    blacklist_keywords: string,
    locations_p1: string,
    locations_p2: string,
    locations_p3: string,
}

component IconButton inherits Rectangle {
    in property <image> icon;
    in property <length> icon-size: 16px;
    in property <bool> active: false;
    callback clicked;
    
    width: 32px;
    height: 32px;
    border-radius: 4px;
    background: active ? #3a3a3a : touch.pressed ? #3a3a3a : touch.has-hover ? #2d2d2d : transparent;

    Image {
        source: icon;
        width: icon-size;
        height: icon-size;
        colorize: #cccccc;
    }

    touch := TouchArea {
        clicked => { root.clicked(); }
    }
}

component JobListItem inherits Rectangle {
    in property <JobEntry> job;
    in property <bool> selected: false;
    callback clicked;

    height: 80px;
    background: selected ? #2d2d3a : touch.pressed ? #2d2d2d : touch.has-hover ? #252525 : transparent;
    border-radius: 4px;

    touch := TouchArea {
        clicked => { root.clicked(); }
    }

    HorizontalLayout {
        padding: 8px;
        spacing: 10px;

        // Status indicator
        Rectangle {
            width: 4px;
            background: job.rating > 0 ? #ffd700 : #444444;
            border-radius: 2px;
        }

        VerticalLayout {
            spacing: 2px;
            alignment: center;
            
            Text {
                text: job.title;
                color: #ffffff;
                font-size: 14px;
                font-weight: 700;
                overflow: elide;
            }
            
            HorizontalLayout {
                spacing: 5px;
                Text {
                    text: job.employer;
                    color: #999999;
                    font-size: 12px;
                    overflow: elide;
                }
                Text {
                    text: "• " + job.location;
                    color: #4a90e2;
                    font-size: 12px;
                }
            }
        }
        
        Text {
            text: job.date;
            color: #666666;
            font-size: 11px;
            vertical-alignment: center;
        }
    }
}

component InboxPane inherits VerticalLayout {
    in property <[JobEntry]> jobs;
    in property <bool> searching;
    in property <string> status-msg;
    in property <int> selected-index;
    
    callback search-pressed(string);
    callback search-prio(int);
    callback job-selected(string, int);

    padding: 10px;
    spacing: 10px;

    // Search bar and Prio buttons
    VerticalLayout {
        spacing: 8px;
        
        HorizontalLayout {
            height: 40px;
            spacing: 10px;
            
            search-input := LineEdit {
                placeholder-text: "Fri sökning (ignorerar Prio-filter)...";
                accepted => { root.search-pressed(self.text); }
            }
            
            Button {
                text: root.searching ? "..." : "Sök";
                width: 60px;
                enabled: !root.searching;
                clicked => { root.search-pressed(search-input.text); }
            }
        }

        HorizontalLayout {
            height: 30px;
            spacing: 5px;
            alignment: start;
            
            Text { 
                text: "Ladda:"; 
                vertical-alignment: center; 
                color: #888888;
                font-size: 12px;
            }
            
            Button { text: "Prio 1"; width: 60px; clicked => { root.search-prio(1); } }
            Button { text: "Prio 2"; width: 60px; clicked => { root.search-prio(2); } }
            Button { text: "Prio 3"; width: 60px; clicked => { root.search-prio(3); } }
        }
    }

    // Tools
    Rectangle {
        height: 40px;
        background: #252525;
        border-radius: 4px;
        HorizontalLayout {
            padding: 4px;
            spacing: 8px;
            alignment: start;
            IconButton { icon: @image-url("../assets/icons/bookmark-star-fill.svg"); }
            Text {
                text: root.status-msg;
                color: #888888;
                font-size: 12px;
                vertical-alignment: center;
            }
        }
    }

    // List
    Rectangle {
        background: #1e1e1e;
        border-radius: 4px;
        border-width: 1px;
        border-color: #333333;
        
        ScrollView {
            VerticalLayout {
                for job[idx] in jobs : JobListItem {
                    job: job;
                    selected: idx == root.selected-index;
                    clicked => {
                        root.job-selected(job.id, idx);
                    }
                }
            }
        }
        
        if jobs.length == 0 && !searching : Text {
            text: "Ladda en prioritet eller sök...";
            color: #555555;
            x: parent.width / 2 - self.width / 2;
            y: parent.height / 2 - self.height / 2;
        }
    }
}

component JobDetailPane inherits Rectangle {
    in property <JobEntry> job;
    callback close;
    
    background: #1e1e1e;
    
    VerticalLayout {
        padding: 20px;
        spacing: 15px;
        
        // Header with Back button
        HorizontalLayout {
            height: 30px;
            IconButton {
                icon: @image-url("../assets/icons/chevron-left.svg");
                clicked => { root.close(); }
            }
            Text {
                text: "Tillbaka";
                vertical-alignment: center;
                color: #888888;
                font-size: 12px;
            }
            Rectangle {} // Spacer
        }

        Text {
            text: job.title;
            font-size: 22px;
            font-weight: 700;
            color: #ffffff;
            wrap: word-wrap;
        }
        
        HorizontalLayout {
            spacing: 10px;
            Text { text: job.employer; color: #aaaaaa; font-size: 14px; }
            Text { text: "•"; color: #666666; }
            Text { text: job.location; color: #aaaaaa; font-size: 14px; }
        }

        // Action Bar
        Rectangle {
            height: 50px;
            background: #252525;
            border-radius: 8px;
            HorizontalLayout {
                alignment: space-around;
                padding: 5px;
                IconButton { icon: @image-url("../assets/icons/bookmark-star-fill.svg"); icon-size: 20px; }
                IconButton { icon: @image-url("../assets/icons/hand-thumbs-up-fill.svg"); icon-size: 20px; }
                IconButton { icon: @image-url("../assets/icons/hand-thumbs-down-fill.svg"); icon-size: 20px; }
                IconButton { icon: @image-url("../assets/icons/globe.svg"); icon-size: 20px; }
            }
        }

        // Description
        ScrollView {
            Text {
                text: job.description;
                color: #dddddd;
                font-size: 14px;
                wrap: word-wrap;
                width: parent.width;
            }
        }
    }
}

component JobDetailContainer inherits Rectangle {
    in property <JobEntry> job;
    in property <bool> has-selection;
    callback close;
    
    background: #121212;
    
    if has-selection : JobDetailPane {
        width: 100%;
        height: 100%;
        job: job;
        close => { root.close(); }
    }

    if !has-selection : Text {
        text: "Välj ett jobb för att se detaljer";
        color: #444444;
        x: parent.width / 2 - self.width / 2;
        y: parent.height / 2 - self.height / 2;
    }
}

component InboxPage inherits Rectangle {
    in property <[JobEntry]> jobs;
    in property <bool> searching;
    in property <string> status-msg;
    
    in-out property <int> selected-index: -1;
    property <bool> has-selection: selected-index >= 0;
    
    callback search-pressed(string);
    callback search-prio(int);
    callback job-selected(string);

    // Desktop Layout (> 700px)
    if root.width > 700px : HorizontalLayout {
        InboxPane {
            width: 350px;
            jobs: root.jobs;
            searching: root.searching;
            status-msg: root.status-msg;
            selected-index: root.selected-index;
            search-pressed(s) => { root.search-pressed(s); }
            search-prio(p) => { root.search-prio(p); }
            job-selected(id, idx) => { 
                root.selected-index = idx;
                root.job-selected(id); 
            }
        }
        
        Rectangle { width: 1px; background: #333333; }

        JobDetailContainer {
            job: root.jobs[root.selected-index];
            has-selection: root.has-selection;
            close => { root.selected-index = -1; }
        }
    }

    // Mobile Layout (<= 700px)
    if root.width <= 700px : Rectangle {
        if !root.has-selection : InboxPane {
            width: 100%;
            height: 100%;
            jobs: root.jobs;
            searching: root.searching;
            status-msg: root.status-msg;
            selected-index: root.selected-index;
            search-pressed(s) => { root.search-pressed(s); }
            search-prio(p) => { root.search-prio(p); }
            job-selected(id, idx) => { 
                root.selected-index = idx;
                root.job-selected(id); 
            }
        }

        if root.has-selection : JobDetailContainer {
            width: 100%;
            height: 100%;
            job: root.jobs[root.selected-index];
            has-selection: root.has-selection;
            close => { root.selected-index = -1; }
        }
    }
}

component SettingsPage inherits VerticalLayout {
    in-out property <AppSettings> settings;
    callback save-settings(AppSettings);

    padding: 20px;
    spacing: 10px; // Tightened spacing
    alignment: start;

    Text {
        text: "Inställningar";
        font-size: 24px;
        font-weight: 700;
        color: #ffffff;
    }
    
    ScrollView {
        VerticalLayout {
            spacing: 15px;
            
            VerticalLayout {
                spacing: 5px;
                Text { text: "Sökord (inkludera):"; color: #aaaaaa; }
                keywords-input := LineEdit {
                    text: root.settings.keywords;
                    placeholder-text: "t.ex. rust, python";
                }
            }

            VerticalLayout {
                spacing: 5px;
                Text { text: "Blockord (exkludera):"; color: #ff6666; }
                blacklist-input := LineEdit {
                    text: root.settings.blacklist_keywords;
                    placeholder-text: "t.ex. säljare, telemarketing";
                }
            }

            VerticalLayout {
                spacing: 5px;
                Text { text: "Område Prio 1:"; color: #4a90e2; }
                loc-p1-input := LineEdit {
                    text: root.settings.locations_p1;
                    placeholder-text: "t.ex. stockholm (eller kod)";
                }
            }

            VerticalLayout {
                spacing: 5px;
                Text { text: "Område Prio 2:"; color: #4a90e2; }
                loc-p2-input := LineEdit {
                    text: root.settings.locations_p2;
                }
            }

            VerticalLayout {
                spacing: 5px;
                Text { text: "Område Prio 3:"; color: #4a90e2; }
                loc-p3-input := LineEdit {
                    text: root.settings.locations_p3;
                }
            }
            
            Button {
                text: "Spara inställningar";
                primary: true;
                clicked => {
                    root.settings.keywords = keywords-input.text;
                    root.settings.blacklist_keywords = blacklist-input.text;
                    root.settings.locations_p1 = loc-p1-input.text;
                    root.settings.locations_p2 = loc-p2-input.text;
                    root.settings.locations_p3 = loc-p3-input.text;
                    root.save-settings(root.settings);
                }
            }
        }
    }
}

export component App inherits Window {
    title: "Jobseeker";
    min-width: 400px;
    min-height: 800px;
    background: #121212; // Dark theme background
    preferred-width: 900px; // Wider default for desktop
    preferred-height: 800px;

    in-out property <[JobEntry]> jobs: [];
    in-out property <bool> searching: false;
    in-out property <string> status-msg: "Redo";
    in-out property <int> current-tab: 0;
    
    // Default settings
    in-out property <AppSettings> settings: {
        keywords: "",
        blacklist_keywords: "",
        locations_p1: "",
        locations_p2: "",
        locations_p3: ""
    };

    callback search-pressed(string);
    callback search-prio(int);
    callback job-selected(string);
    callback save-settings(AppSettings);

    VerticalLayout {
        // Content Area
        Rectangle {
            clip: true;
            if root.current-tab == 0 : InboxPage {
                jobs: root.jobs;
                searching: root.searching;
                status-msg: root.status-msg;
                search-pressed(q) => { root.search-pressed(q); }
                search-prio(p) => { root.search-prio(p); }
                job-selected(id) => { root.job-selected(id); }
            }
            if root.current-tab == 1 : Rectangle {
                Text { text: "Utkast (Kommer snart)"; color: white; }
            }
            if root.current-tab == 2 : SettingsPage {
                settings: root.settings;
                save-settings(s) => { root.save-settings(s); }
            }
        }

        // Bottom Navigation Bar
        Rectangle {
            height: 60px;
            background: #1e1e1e;
            
            // Top border
            Rectangle {
                y: 0;
                width: 100%;
                height: 1px;
                background: #333333;
            }

            HorizontalLayout {
                alignment: space-around;
                
                // Inbox Tab
                VerticalLayout {
                    alignment: center;
                    spacing: 4px;
                    width: 60px;
                    
                    touch-inbox := TouchArea {
                        clicked => { root.current-tab = 0; }
                    }
                    
                    Image {
                        source: @image-url("../assets/icons/inbox-fill.svg");
                        width: 24px;
                        height: 24px;
                        colorize: root.current-tab == 0 ? #4a90e2 : #666666;
                        x: (parent.width - self.width) / 2;
                    }
                    Text {
                        text: "Inbox";
                        font-size: 10px;
                        color: root.current-tab == 0 ? #4a90e2 : #666666;
                        horizontal-alignment: center;
                    }
                }

                // Drafts Tab
                VerticalLayout {
                    alignment: center;
                    spacing: 4px;
                    width: 60px;
                    
                    touch-drafts := TouchArea {
                        clicked => { root.current-tab = 1; }
                    }

                    Image {
                        source: @image-url("../assets/icons/clipboard-plus-fill.svg");
                        width: 24px;
                        height: 24px;
                        colorize: root.current-tab == 1 ? #4a90e2 : #666666;
                        x: (parent.width - self.width) / 2;
                    }
                    Text {
                        text: "Utkast";
                        font-size: 10px;
                        color: root.current-tab == 1 ? #4a90e2 : #666666;
                        horizontal-alignment: center;
                    }
                }

                // Settings Tab
                VerticalLayout {
                    alignment: center;
                    spacing: 4px;
                    width: 60px;

                    touch-settings := TouchArea {
                        clicked => { root.current-tab = 2; }
                    }

                    Image {
                        source: @image-url("../assets/icons/gear-fill.svg");
                        width: 24px;
                        height: 24px;
                        colorize: root.current-tab == 2 ? #4a90e2 : #666666;
                        x: (parent.width - self.width) / 2;
                    }
                    Text {
                        text: "Inställ.";
                        font-size: 10px;
                        color: root.current-tab == 2 ? #4a90e2 : #666666;
                        horizontal-alignment: center;
                    }
                }
            }
        }
    }
}