import { Button, LineEdit, ScrollView, TextEdit, CheckBox, HorizontalBox, VerticalBox, TabWidget } from "std-widgets.slint";

export struct JobEntry {
    id: string,
    title: string,
    employer: string,
    location: string,
    description: string,
    date: string,
    rating: int,
    status: int, // 0=New, 1=Rejected, 2=Saved, 3=ThumbsUp, 4=Applied
    status_text: string,
}

export struct AppSettings {
    keywords: string,
    blacklist_keywords: string,
    locations_p1: string,
    locations_p2: string,
    locations_p3: string,
    my_profile: string,
    ollama_url: string,
    app_min_count: int,
    app_goal_count: int,
    show_motivation: bool,
}

component IconButton inherits Rectangle {
    in property <image> icon;
    in property <length> icon-size: 16px;
    in property <bool> active: false;
    in property <bool> danger: false;
    callback clicked;

    width: 32px;
    height: 32px;
    border-radius: 4px;

    Rectangle {
        background: active ? (danger ? #802020 : #4a90e2) : touch.pressed ? #3a3a3a : touch.has-hover ? #2d2d2d : transparent;
        width: 100%;
        height: 100%;
        border-radius: 4px;
    }

    Image {
        source: icon;
        width: icon-size;
        height: icon-size;
        colorize: active ? #ffffff : (danger ? #ff6666 : #cccccc);
    }

    touch := TouchArea {
        clicked => { root.clicked(); }
    }
}

component JobListItem inherits Rectangle {
    in property <JobEntry> job;
    in property <bool> selected: false;
    callback clicked;

    height: 68px;
    background: selected ? #2d2d3a : touch.pressed ? #2d2d2d : touch.has-hover ? #252525 : transparent;
    border-radius: 4px;

    touch := TouchArea {
        clicked => { root.clicked(); }
    }

    // Vi anv√§nder en Rectangle som "canvas" ist√§llet f√∂r layouts
    // f√∂r att kunna l√•sa positionerna p√• pixelniv√•.
    container := Rectangle {

        // 1. Status-indikator (V√§nster)
        Rectangle {
            x: 8px;
            y: (parent.height - self.height) / 2;
            width: 4px;
            height: 40px;
            background: job.status == 4 ? #00ff00 : (job.status == 3 ? #00ffff : (job.status == 2 ? #ffd700 : #444444));
            border-radius: 2px;
        }

        // 2. Titel (L√•st till y: 16px)
        Text {
            x: 22px;
            y: 16px;
            text: job.title;
            color: #ffffff;
            font-size: 14px;
            font-weight: 700;
            width: parent.width - 100px;
            overflow: elide;
        }

        // 3. Info-rad (L√•st till y: 36px)
        // Genom att l√§gga b√•de employer och location i samma Text-str√§ng
        // garanterar vi att de ALDRIG kan vara o j√§mna mot varandra.
        Text {
            x: 22px;
            y: 36px;
            text: job.employer + " ‚Ä¢ " + job.location;
            color: #999999;
            font-size: 12px;
            width: parent.width - 100px;
            overflow: elide;
        }

        // 4. Datum (H√∂gst upp till h√∂ger)
        Text {
            x: parent.width - self.width - 8px;
            y: 18px;
            text: job.date;
            color: #666666;
            font-size: 10px;
        }

        // 5. Status-text (L√§ngst ner till h√∂ger)
        if job.status == 4 : Text {
            x: parent.width - self.width - 8px;
            y: 36px;
            text: "S√ñKT";
            color: #00ff00;
            font-size: 10px;
            font-weight: 700;
        }
    }
}

component InboxPane inherits VerticalLayout {
    in property <[JobEntry]> jobs;
    in property <bool> searching;
    in-out property <string> status-msg: "Redo";
    in-out property <int> selected-index: -1;
    in-out property <int> active-filter: 0;
    in-out property <string> active-month: "2026-01";
    in-out property <string> active-month-display: "Januari 2026";
    in-out property <int> applied-count: 0;
    in property <int> app-min-count: 6;
    in property <int> app-goal-count: 12;

    callback search-pressed(string);
    callback search-prio(int);
    callback job-selected(string, int);
    callback month-offset(int);

    padding: 10px;
    spacing: 5px;

    // Progress Section
    Rectangle {
        height: 20px;
        HorizontalLayout {
            alignment: space-between;
            Text {
                text: root.applied-count < root.app-min-count 
                    ? (root.app-min-count - root.applied-count) + " kvar till minimum"
                    : (root.applied-count < root.app-goal-count 
                        ? (root.app-goal-count - root.applied-count) + " kvar till m√•let"
                        : "M√•let √§r n√•tt! üéâ");
                color: root.applied-count < root.app-min-count ? #ff6666 : (root.applied-count < root.app-goal-count ? #ffd700 : #00ff00);
                font-size: 11px;
                font-weight: 700;
            }
            Text {
                text: "Totalt s√∂kta: " + root.applied-count;
                color: #888888;
                font-size: 11px;
            }
        }
    }

    // Search & Filter Section
    Rectangle {
        background: #1a1a1a;
        border-radius: 8px;
        preferred-height: 160px;

        VerticalLayout {
            padding: 8px;
            spacing: 8px;

            HorizontalLayout {
                height: 36px;
                spacing: 8px;
                search-input := LineEdit {
                    placeholder-text: "Fri s√∂kning...";
                    accepted => { root.search-pressed(self.text); }
                }
                Button {
                    text: root.searching ? "..." : "S√∂k";
                    width: 60px;
                    enabled: !root.searching;
                    clicked => { root.search-pressed(search-input.text); }
                }
            }

            HorizontalLayout {
                spacing: 4px;
                alignment: space-between;
                Button { text: root.searching ? "..." : "P1"; width: 45px; enabled: !root.searching; clicked => { root.status-msg = "Laddar Prio 1..."; root.search-prio(1); } }
                Button { text: root.searching ? "..." : "P2"; width: 45px; enabled: !root.searching; clicked => { root.status-msg = "Laddar Prio 2..."; root.search-prio(2); } }
                Button { text: root.searching ? "..." : "P3"; width: 45px; enabled: !root.searching; clicked => { root.status-msg = "Laddar Prio 3..."; root.search-prio(3); } }
                Rectangle { width: 10px; } // Spacer
                IconButton { icon: @image-url("../assets/icons/bookmark-star-fill.svg"); active: root.active-filter == 2; clicked => { root.active-filter = (root.active-filter == 2 ? 0 : 2); } }
                IconButton { icon: @image-url("../assets/icons/hand-thumbs-up-fill.svg"); active: root.active-filter == 3; clicked => { root.active-filter = (root.active-filter == 3 ? 0 : 3); } }
                IconButton { icon: @image-url("../assets/icons/check-circle-fill.svg"); active: root.active-filter == 4; clicked => { root.active-filter = (root.active-filter == 4 ? 0 : 4); } }
            }

            // Month Selector
            HorizontalLayout {
                height: 32px;
                alignment: center;
                spacing: 12px;
                IconButton { icon: @image-url("../assets/icons/chevron-left.svg"); clicked => { root.month-offset(-1); } }
                Text {
                    text: root.active-month-display;
                    vertical-alignment: center;
                    horizontal-alignment: center;
                    color: #ffffff;
                    font-weight: 700;
                    width: 140px;
                }
                IconButton { icon: @image-url("../assets/icons/chevron-right.svg"); clicked => { root.month-offset(1); } }
            }
        }
    }

    // List Area
    Rectangle {
        background: #1e1e1e;
        border-radius: 4px;
        vertical-stretch: 1;
        clip: true;

        ScrollView {
            VerticalLayout {
                alignment: start;
                spacing: 4px;
                padding: 4px;

                for job[idx] in jobs : JobListItem {
                    visible: root.active-filter == 0 || job.status == root.active-filter;
                    height: self.visible ? 72px : 0px;
                    job: job;
                    selected: idx == root.selected-index;
                    clicked => { root.job-selected(job.id, idx); }
                }
            }
        }

        if jobs.length == 0 && !searching : Text {
            text: "Hittade inga annonser";
            color: #555555;
            vertical-alignment: center;
            horizontal-alignment: center;
        }
    }

    // Status message at the very bottom
    Text {
        text: root.status-msg;
        color: #666666;
        font-size: 10px;
        horizontal-alignment: right;
    }
}

component JobDetailPane inherits Rectangle {
    in property <JobEntry> job;
    callback close;
    callback action(string);
    callback copy(string);

    background: #1e1e1e;

    VerticalLayout {
        padding: 20px;
        spacing: 15px;

        HorizontalLayout {
            height: 32px;
            IconButton {
                icon: @image-url("../assets/icons/chevron-left.svg");
                clicked => { root.close(); }
            }
            Text { text: " Tillbaka"; vertical-alignment: center; color: #888888; }
            Rectangle { } // Spacer
        }

        Text {
            text: job.title;
            font-size: 20px;
            font-weight: 700;
            color: #ffffff;
            wrap: word-wrap;
        }

        // Reporting Help (Sticky top if applied)
        if job.status == 4 : Rectangle {
            background: #1a2e1a;
            border-radius: 4px;
            border-width: 1px;
            border-color: #00ff00;
            height: 75px;
            VerticalLayout {
                padding: 8px;
                spacing: 4px;
                Text { text: "KOPIERA TILL RAPPORT"; color: #00ff00; font-weight: 700; font-size: 9px; }
                HorizontalLayout {
                    spacing: 4px;
                    Button { text: "F√∂retag"; clicked => { root.copy(job.employer); } }
                    Button { text: "Kommun"; clicked => { root.copy(job.location); } }
                    Button { text: "Titel"; clicked => { root.copy(job.title); } }
                }
            }
        }

        // Action Bar
        HorizontalLayout {
            spacing: 10px;
            alignment: center;
            IconButton { icon: @image-url("../assets/icons/hand-thumbs-down-fill.svg"); icon-size: 20px; danger: true; clicked => { root.action("reject"); } }
            IconButton { icon: @image-url("../assets/icons/bookmark-star-fill.svg"); icon-size: 20px; active: job.status == 2; clicked => { root.action("save"); } }
            IconButton { icon: @image-url("../assets/icons/hand-thumbs-up-fill.svg"); icon-size: 20px; active: job.status == 3; clicked => { root.action("thumbsup"); } }
            IconButton { icon: @image-url("../assets/icons/check-circle-fill.svg"); icon-size: 20px; active: job.status == 4; clicked => { root.action("apply"); } }
            IconButton { icon: @image-url("../assets/icons/globe.svg"); icon-size: 20px; clicked => { root.action("open"); } }
        }

        ScrollView {
            Text {
                text: job.description;
                color: #dddddd;
                font-size: 14px;
                wrap: word-wrap;
                width: parent.width;
            }
        }
    }
}

component SettingsPage inherits Rectangle {
    in-out property <AppSettings> settings;
    in property <string> system-logs;
    in property <string> log_file_path;
    in property <string> last_api_request;
    callback save-settings(AppSettings);
    callback clear-logs;
    callback copy-text(string);

    background: #121212;

    VerticalLayout {
        padding: 20px;
        spacing: 15px;

        Text { text: "Inst√§llningar"; font-size: 24px; font-weight: 700; color: #ffffff; }

        ScrollView {
            VerticalLayout {
                spacing: 15px;

                Text { text: "S√ñKORD"; color: #4a90e2; font-weight: 700; font-size: 11px; }
                keywords-input := LineEdit { text: root.settings.keywords; placeholder-text: "Inkludera s√∂kord..."; }
                blacklist-input := LineEdit { text: root.settings.blacklist_keywords; placeholder-text: "Blockera ord..."; }

                Text { text: "PRIORITERADE OMR√ÖDEN"; color: #4a90e2; font-weight: 700; font-size: 11px; }
                loc-p1 := LineEdit { text: root.settings.locations_p1; placeholder-text: "Prio 1 (Kommuner)..."; }
                loc-p2 := LineEdit { text: root.settings.locations_p2; placeholder-text: "Prio 2 (Kommuner)..."; }
                loc-p3 := LineEdit { text: root.settings.locations_p3; placeholder-text: "Prio 3 (Kommuner)..."; }

                Text { text: "AI PROFIL"; color: #ffd700; font-weight: 700; font-size: 11px; }
                profile-input := TextEdit { text: root.settings.my_profile; height: 100px; }

                Text { text: "ANS√ñKNINGSM√ÖL"; color: #00ff00; font-weight: 700; font-size: 11px; }
                HorizontalLayout {
                    spacing: 10px;
                    VerticalLayout {
                        Text { text: "Minimum"; color: #888; font-size: 10px; }
                        min-input := LineEdit { text: root.settings.app_min_count; placeholder-text: "6"; input-type: number; }
                    }
                    VerticalLayout {
                        Text { text: "M√•l"; color: #888; font-size: 10px; }
                        goal-input := LineEdit { text: root.settings.app_goal_count; placeholder-text: "12"; input-type: number; }
                    }
                }
                CheckBox {
                    text: "Visa sporrande meddelanden";
                    checked: root.settings.show_motivation;
                    toggled => { root.settings.show_motivation = self.checked; }
                }

                // Visible log file path and last API request for easier troubleshooting
                Text { text: "Loggfil:"; color: #999999; font-size: 11px; }
                Text { text: root.log_file_path; color: #999999; font-size: 11px; }
                Text { text: "Senaste API-request:"; color: #999999; font-size: 11px; }
                Text { text: root.last_api_request; color: #999999; font-family: "monospace"; font-size: 10px; }

                Rectangle {
                    background: #000;
                    height: 200px;
                    ScrollView {
                        Text { text: root.system-logs; color: #00ff00; font-family: "monospace"; font-size: 10px; }
                    }
                }

                Button {
                    text: "Spara Inst√§llningar";
                    primary: true;
                    clicked => {
                        root.settings.keywords = keywords-input.text;
                        root.settings.blacklist_keywords = blacklist-input.text;
                        root.settings.locations_p1 = loc-p1.text;
                        root.settings.locations_p2 = loc-p2.text;
                        root.settings.locations_p3 = loc-p3.text;
                        root.settings.my_profile = profile-input.text;
                        root.settings.app_min_count = min-input.text.to-float();
                        root.settings.app_goal_count = goal-input.text.to-float();
                        root.save-settings(root.settings);
                    }
                }
            }
        }
    }
}

export component App inherits Window {
    title: "Jobseeker 2026";
    min-width: 380px;
    min-height: 500px;
    background: #121212;
    preferred-width: 900px;
    preferred-height: 800px;

    in-out property <int> selected-index: -1;
    in-out property <[JobEntry]> jobs: [];
    in-out property <bool> searching: false;
    in-out property <string> status-msg: "Redo";
    in-out property <int> current-tab: 0;
    in-out property <string> active-month: "2026-01";
    in-out property <string> active-month-display: "Januari 2026";
    in-out property <string> system-logs: "";
    in-out property <string> log_file_path: "";
    in-out property <string> last_api_request: "";
    in-out property <int> applied-count: 0;
    in-out property <AppSettings> settings: { ollama_url: "http://localhost:11434/v1", app_min_count: 6, app_goal_count: 12, show_motivation: true };

    callback search-pressed(string);
    callback search-prio(int);
    callback job-selected(string, int);
    callback job-action(string, string);
    callback copy-text(string);
    callback month-offset(int);
    callback save-settings(AppSettings);

    VerticalLayout {
        // Main View
        Rectangle {
            vertical-stretch: 1;

            if current-tab == 0 : Rectangle {
                // Responsive Split View
                if root.width > 750px : HorizontalLayout {
                    InboxPane {
                        width: 350px;
                        jobs: root.jobs;
                        searching: root.searching;
                        status-msg: root.status-msg;
                        selected-index: root.selected-index;
                        active-month: root.active-month;
                        active-month-display: root.active-month-display;
                        applied-count: root.applied-count;
                        app-min-count: root.settings.app_min_count;
                        app-goal-count: root.settings.app_goal_count;
                        job-selected(id, idx) => { root.selected-index = idx; root.job-selected(id, idx); }
                        month-offset(off) => { root.month-offset(off); }
                        search-pressed(q) => { root.search-pressed(q); }
                        search-prio(p) => { root.search-prio(p); }
                    }
                    Rectangle { width: 1px; background: #333; }
                    if root.selected-index >= 0 : JobDetailPane {
                        job: root.jobs[root.selected-index];
                        close => { root.selected-index = -1; }
                        action(act) => { root.job-action(root.jobs[root.selected-index].id, act); }
                        copy(t) => { root.copy-text(t); }
                    }
                    if root.selected-index < 0 : Text { text: "V√§lj ett jobb"; color: #444; vertical-alignment: center; horizontal-alignment: center; }
                }

                if root.width <= 750px : Rectangle {
                    if root.selected-index < 0 : InboxPane {
                        jobs: root.jobs;
                        searching: root.searching;
                        status-msg: root.status-msg;
                        active-month: root.active-month;
                        active-month-display: root.active-month-display;
                        applied-count: root.applied-count;
                        app-min-count: root.settings.app_min_count;
                        app-goal-count: root.settings.app_goal_count;
                        job-selected(id, idx) => { root.selected-index = idx; root.job-selected(id, idx); }
                        month-offset(off) => { root.month-offset(off); }
                        search-pressed(q) => { root.search-pressed(q); }
                        search-prio(p) => { root.search-prio(p); }
                    }
                    if root.selected-index >= 0 : JobDetailPane {
                        job: root.jobs[root.selected-index];
                        close => { root.selected-index = -1; }
                        action(act) => { root.job-action(root.jobs[root.selected-index].id, act); }
                        copy(t) => { root.copy-text(t); }
                    }
                }
            }

            if root.current-tab == 1 : SettingsPage {
                settings: root.settings;
                log_file_path: root.log_file_path;
                last_api_request: root.last_api_request;
                save-settings(s) => { root.save-settings(s); }
            }
        }

        // Bottom Bar
        Rectangle {
            height: 60px;
            background: #1e1e1e;
            HorizontalLayout {
                alignment: space-around;
                padding-top: 5px;

                // Tab 0: Inkorg
                VerticalLayout {
                    spacing: 4px;
                    alignment: center;
                    IconButton {
                        icon: @image-url("../assets/icons/inbox-fill.svg");
                        active: root.current-tab == 0;
                        clicked => { root.current-tab = 0; }
                    }
                    Text { text: "Jobb"; font-size: 10px; color: root.current-tab == 0 ? #4a90e2 : #666; horizontal-alignment: center; }
                }

                // Tab 1: Inst√§llningar
                VerticalLayout {
                    spacing: 4px;
                    alignment: center;
                    IconButton {
                        icon: @image-url("../assets/icons/gear-fill.svg");
                        active: root.current-tab == 1;
                        clicked => { root.current-tab = 1; }
                    }
                    Text { text: "Inst√§llningar"; font-size: 10px; color: root.current-tab == 1 ? #4a90e2 : #666; horizontal-alignment: center; }
                }
            }
        }
    }
}
