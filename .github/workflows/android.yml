name: Android Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  android:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android
          
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          
      - name: Setup Android NDK
        run: |
          echo "ANDROID_HOME=${ANDROID_SDK_ROOT}" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=${ANDROID_SDK_ROOT}/ndk-bundle" >> $GITHUB_ENV
          
      - name: Install Android Platform
        run: |
          yes | sdkmanager --licenses
          sdkmanager --install "platforms;android-30" "build-tools;30.0.3" "platform-tools"
          
      - name: Install cargo-apk
        run: cargo install cargo-apk
        
      - name: Build APK
        run: |
          # Build specifically for aarch64 (most common for modern phones)
          cargo apk build --release
        
      - name: Prepare Assets
        run: |
          mkdir -p release_assets
          find target -name "*.apk" -exec cp {} release_assets/jobseeker-android.apk \;
          ls -lh release_assets/

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: release_assets/*.apk
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
