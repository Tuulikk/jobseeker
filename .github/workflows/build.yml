name: Multi-OS Build & Release

on:
  push:
    branches:
      - main
      - slint-conversion
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  build-desktop:
    name: Build ${{ matrix.asset_name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            asset_name: jobseeker-linux-amd64
            
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            asset_name: jobseeker-windows-amd64.exe
            
          - os: macos-latest
            target: x86_64-apple-darwin
            asset_name: jobseeker-macos-intel.zip
            
          - os: macos-latest
            target: aarch64-apple-darwin
            asset_name: jobseeker-macos-arm64.zip

    steps:
    - uses: actions/checkout@v4
    
    - name: Install Linux Dependencies
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y libsoup-3.0-dev libgtk-4-dev libadwaita-1-dev libasound2-dev libvulkan-dev
        
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}
        
    - name: Rust Cache
      uses: Swatinem/rust-cache@v2

    - name: Build
      run: cargo build --release --verbose --target ${{ matrix.target }}
      
    - name: Prepare Artifact
      shell: bash
      run: |
        mkdir -p dist
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          cp target/${{ matrix.target }}/release/Jobseeker.exe dist/${{ matrix.asset_name }}
        elif [[ "${{ matrix.os }}" == "macos-latest" ]]; then
          APP_NAME="Jobseeker.app"
          mkdir -p "$APP_NAME/Contents/MacOS"
          mkdir -p "$APP_NAME/Contents/Resources"
          cp "target/${{ matrix.target }}/release/Jobseeker" "$APP_NAME/Contents/MacOS/Jobseeker"
          chmod +x "$APP_NAME/Contents/MacOS/Jobseeker"
          INFO_PLIST="$APP_NAME/Contents/Info.plist"
          echo '<?xml version="1.0" encoding="UTF-8"?>' > "$INFO_PLIST"
          echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> "$INFO_PLIST"
          echo '<plist version="1.0">' >> "$INFO_PLIST"
          echo '<dict>' >> "$INFO_PLIST"
          echo '    <key>CFBundleExecutable</key>' >> "$INFO_PLIST"
          echo '    <string>Jobseeker</string>' >> "$INFO_PLIST"
          echo '    <key>CFBundleIdentifier</key>' >> "$INFO_PLIST"
          echo '    <string>com.gnawsoftware.jobseeker</string>' >> "$INFO_PLIST"
          echo '    <key>CFBundleName</key>' >> "$INFO_PLIST"
          echo '    <string>Jobseeker</string>' >> "$INFO_PLIST"
          echo '    <key>CFBundleVersion</key>' >> "$INFO_PLIST"
          echo "    <string>${{ github.ref_name }}</string>" >> "$INFO_PLIST"
          echo '    <key>CFBundleShortVersionString</key>' >> "$INFO_PLIST"
          echo "    <string>${{ github.ref_name }}</string>" >> "$INFO_PLIST"
          echo '    <key>LSMinimumSystemVersion</key>' >> "$INFO_PLIST"
          echo '    <string>10.13</string>' >> "$INFO_PLIST"
          echo '    <key>NSHighResolutionCapable</key>' >> "$INFO_PLIST"
          echo '    <true/>' >> "$INFO_PLIST"
          echo '</dict>' >> "$INFO_PLIST"
          echo '</plist>' >> "$INFO_PLIST"
          zip -r "dist/${{ matrix.asset_name }}" "$APP_NAME"
        else
          cp target/${{ matrix.target }}/release/Jobseeker dist/${{ matrix.asset_name }}
        fi

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.asset_name }}
        path: dist/${{ matrix.asset_name }}

    - name: Upload to Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/slint-conversion'
      with:
        tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || 'latest-dev' }}
        name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || 'Latest Development Build' }}
        prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
        files: dist/${{ matrix.asset_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    env:
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      NDK_VERSION: "25.2.9519653"
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Install NDK and Tools
        run: |
          sdkmanager --install "ndk;$NDK_VERSION" "platforms;android-30" "build-tools;30.0.3" "platform-tools"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android
          
      - name: Install cargo-apk
        run: cargo install cargo-apk

      - name: Generate Dummy Keystore
        run: |
          keytool -genkey -v -keystore dummy.keystore -alias android -keyalg RSA -keysize 2048 -validity 10000 -storepass password -keypass password -dname "CN=Android Debug,O=Android,C=US"
        
      - name: Build APK
        run: |
          cargo apk build --release --lib
        
      - name: Prepare Assets
        run: |
          mkdir -p dist
          find target -name "*.apk" -exec cp {} dist/jobseeker-android.apk \;

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: jobseeker-android.apk
          path: dist/jobseeker-android.apk

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/slint-conversion'
        with:
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || 'latest-dev' }}
          name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || 'Latest Development Build' }}
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
          files: dist/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
