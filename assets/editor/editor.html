<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rich Text Editor</title>
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #ffffff;
            height: 100vh;
            overflow: hidden;
        }
        #editor-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .toolbar {
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
            padding: 8px 12px;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .toolbar button {
            padding: 6px 12px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .toolbar button:hover {
            background: #e8e8e8;
        }
        .toolbar button:active {
            background: #d0d0d0;
        }
        .editor-wrapper {
            flex: 1;
            overflow: hidden;
            padding: 20px;
        }
        #content {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
        }
    </style>
</head>
<body>
    <div id="editor-container">
        <div id="content"></div>
    </div>

    <script>
        let editorInstance = null;

        // Initialize TinyMCE
        tinymce.init({
            selector: '#content',
            license_key: 'gpl',
            height: '100%',
            menubar: true,
            plugins: [
                'advlist', 'autolink', 'lists', 'link', 'charmap', 'preview',
                'searchreplace', 'visualblocks', 'code', 'fullscreen',
                'insertdatetime', 'table', 'wordcount', 'help'
            ],
            toolbar: 'undo redo | blocks | ' +
                'bold italic underline strikethrough | forecolor backcolor | ' +
                'alignleft aligncenter alignright alignjustify | ' +
                'bullist numlist outdent indent | removeformat | help',
            block_formats: 'Paragraph=p; Header 1=h1; Header 2=h2; Header 3=h3; Quote=blockquote; Code=pre',
            content_style: `
                body {
                    font-family: 'Arial', 'Helvetica', sans-serif;
                    font-size: 14px;
                    line-height: 1.6;
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 40px 60px;
                }
                h1 { font-size: 24px; margin: 20px 0 10px; }
                h2 { font-size: 20px; margin: 18px 0 8px; }
                h3 { font-size: 16px; margin: 16px 0 6px; }
                p { margin: 8px 0; }
                blockquote {
                    border-left: 4px solid #ccc;
                    padding-left: 16px;
                    margin: 16px 0;
                    color: #666;
                }
            `,
            statusbar: true,
            branding: false,
            resize: false,
            setup: function(editor) {
                editorInstance = editor;

                editor.on('init', function() {
                    // Signal to Rust that editor is ready
                    window.editorReady = true;

                    // Try to send ready message to Rust
                    if (window.ipc) {
                        window.ipc.postMessage(JSON.stringify({
                            type: 'ready'
                        }));
                    }
                });

                // Auto-save on content change (debounced)
                let saveTimeout;
                editor.on('keyup change', function() {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(function() {
                        saveContent();
                    }, 1000); // Save after 1 second of inactivity
                });
            }
        });

        // API for Rust to call
        window.editorAPI = {
            getContent: function() {
                if (editorInstance) {
                    return editorInstance.getContent();
                }
                return '';
            },

            setContent: function(html) {
                if (editorInstance) {
                    editorInstance.setContent(html || '');
                }
            },

            getPlainText: function() {
                if (editorInstance) {
                    return editorInstance.getContent({format: 'text'});
                }
                return '';
            },

            insertText: function(text) {
                if (editorInstance) {
                    editorInstance.insertContent(text);
                }
            },

            clear: function() {
                if (editorInstance) {
                    editorInstance.setContent('');
                }
            },

            focus: function() {
                if (editorInstance) {
                    editorInstance.focus();
                }
            }
        };

        // Save content back to Rust
        function saveContent() {
            if (editorInstance && window.ipc) {
                const content = editorInstance.getContent();
                window.ipc.postMessage(JSON.stringify({
                    type: 'content_changed',
                    content: content
                }));
            }
        }

        // Listen for messages from Rust
        window.addEventListener('message', function(event) {
            try {
                const data = JSON.parse(event.data);

                switch(data.command) {
                    case 'setContent':
                        window.editorAPI.setContent(data.content);
                        break;
                    case 'getContent':
                        window.ipc.postMessage(JSON.stringify({
                            type: 'content_response',
                            content: window.editorAPI.getContent()
                        }));
                        break;
                    case 'insertText':
                        window.editorAPI.insertText(data.text);
                        break;
                    case 'clear':
                        window.editorAPI.clear();
                        break;
                }
            } catch(e) {
                console.error('Error handling message:', e);
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + S to save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveContent();
            }
        });
    </script>
</body>
</html>
